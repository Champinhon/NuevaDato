{% load static %}
{% load sass_tags %}
<style>
  .custom-width-input {
    width: 80%;
  }

  .message-content table {
    width: auto;
    max-width: 100%;
    overflow-x: auto;
  }

  .custom-table-class {
    overflow-x: auto;
  }

  code {
    white-space: pre-wrap;
    display: block;
    background-color: #f0f0f0;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
</style>
<!-- Agrega Font Awesome para obtener iconos de carga -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

<style>
  .loading-indicator {/* Puedes cambiar el color seg√∫n tu dise√±o */
    display: none; /* Oculta inicialmente la animaci√≥n de carga */
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
<!-- Agrega jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<div class="chat-container">
  <div class="card flex-grow-1">
    <div class="card-header bg-primary text-white">Chat - {{archivo_url}} 
      <a href="{% url 'upload_file' %}" class="btn btn-primary btn-send">Subir Archivo</a>
    </div>
    <div class="stream-content"></div>
    <div class="card-body">
      <ul class="list-unstyled messages-list">
        {% for chat in chats %}
          {% if chat.user == request.user %}
            <li class="message sent">
              <div class="message-text">
                <div class="message-sender">
                  <b>T√∫</b>
                </div>
                <div class="message-content">
                  {{ chat.message }}
                </div>
              </div>
            </li>
            {% if chat.response %}
            <li class="message received">
              <div class="message-text">
                <div class="message-sender">
                  <b>FastAnalisis Bot</b>
                </div>
                <div class="message-content">
                  {% if '.png' in chat.response %}
                    <img src="{{ chat.response }}" alt="Chart">
                    <b>Puedes descargar el gr√°fico aqu√≠: <a href="{{ chat.response }}"  download="chart.png">Descargar</a></b>
                  {% else %}
                    <div style="overflow-x: auto;" class="table table-striped table-bordered table-hover table-sm overflow-auto custom-table-class">
                      {{ chat.response|safe }}
                    </div>
                  {% endif %}
                </div>
              </div>
            </li>
          {% endif %}
          {% endif %}
        {% endfor %}   
        <div id="loading-indicator" class="loading-indicator">
          <i class="fas fa-circle-notch fa-spin"></i> ü§ñ Pensando (esto puede demorar unos minutos dependiendo de la solicitud)...
        </div>  
      </ul>
    </div>
    <br><br>
    <br><br>
    <br><br>
  </div>
  <form class="message-form" method="post" enctype="multipart/form-data" action="{% url 'upload_file' %}">
    {% csrf_token %}
    <div class="input-group">
      <input type="text" class="form-control message-input custom-width-input" placeholder="Escribe tu mensaje..." name="message">
      <div class="input-group-append">
        <button type="submit" class="btn btn-primary btn-send">Enviar</button>
      </div>
    </div>
  </form>
  <br><br>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const messagesList = $('.messages-list');
    const messageForm = $('.message-form');
    const messageInput = $('.message-input');
    const loadingIndicator = $('#loading-indicator');

    messageForm.on('submit', async (event) => {
      event.preventDefault();

      const message = messageInput.val().trim();
      if (message.length === 0) {
        return;
      }
      loadingIndicator.css('display', 'block'); 
      if (loadingIndicator.length > 0) {
        loadingIndicator.css('display', 'block');

        const loadingMessageItem = $('<li class="message loading"></li>');
        loadingMessageItem.html(`
          <div class="message-text">
            <div class="message-sender">
              <b></b>
            </div>
          </div>`);
        messagesList.append(loadingMessageItem);
      }

      const messageItem = $('<li class="message sent"></li>');
      messageItem.html(`
        <div class="message-text">
          <div class="message-sender">
            <b>T√∫</b>
          </div>
          <div class="message-content">
            ${message}
          </div>
        </div>`);
      messagesList.append(messageItem);

      messageInput.val('');

      try {
        const response = await fetch('', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
            'message': message
          })
        });

        const data = await response.json();

        if (loadingIndicator.length > 0) {
          loadingIndicator.css('display', 'none');
        }

        const loadingMessageItem = $('.message.loading');
        if (loadingMessageItem.length > 0) {
          loadingMessageItem.remove();
        }

        const responseItem = $('<li class="message received"></li>');
        responseItem.html(`
          <div class="message-text">
            <div class="message-sender">
              <b>FastAnalisis Bot</b>
            </div>
            <div class="message-content">
              ${data.response}
            </div>
          </div>`);
        messagesList.append(responseItem);

        if (data.response && data.response.includes('.png')) {
          const img = $('<img alt="Chart">').attr('src', data.response);
          responseItem.find('.message-content').append(img);

          const downloadLink = $('<b></b>').html(`Puedes descargar el gr√°fico <a href="${data.response}" download="chart.png">aqu√≠</a>`);
          responseItem.find('.message-content').append(downloadLink);
        }

        // Aseg√∫rate de que el desplazamiento horizontal funcione
        messagesList.animate({ scrollLeft: messagesList.prop('scrollWidth') }, 300);
      } catch (error) {
        console.error('Error al enviar mensaje:', error);
      }
      setInterval(() => {
        const lastMessageContent = $('.message-content').last();
        lastMessageContent.css('overflow-x', 'auto');
      }, 500);
    });
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
